import{Loader as t,LoaderUtils as r,FileLoader as a,Color as s,SpotLight as n,PointLight as i,DirectionalLight as o,MeshBasicMaterial as l,ShaderMaterial as p,UniformsUtils as u,TextureLoader as c,InterleavedBuffer as d,BufferAttribute as h,LinearFilter as m,LinearMipmapLinearFilter as f,RepeatWrapping as v,RGBFormat as g,PointsMaterial as M,Material as T,LineBasicMaterial as S,VertexColors as y,MeshStandardMaterial as R,DoubleSide as _,Vector2 as E,sRGBEncoding as A,BufferGeometry as w,SkinnedMesh as x,Mesh as L,TriangleStripDrawMode as b,TriangleFanDrawMode as I,LineSegments as P,Line as U,LineLoop as O,Points as H,Group as N,PerspectiveCamera as C,Math as F,OrthographicCamera as D,InterpolateLinear as G,AnimationClip as B,Bone as k,Object3D as j,PropertyBinding as K,Matrix4 as V,Scene as z,Skeleton as X,ShaderLib as W,Interpolant as Y,NearestFilter as J,NearestMipmapNearestFilter as Z,LinearMipmapNearestFilter as q,NearestMipmapLinearFilter as Q,ClampToEdgeWrapping as $,MirroredRepeatWrapping as ee,InterpolateDiscrete as te,RGBAFormat as re,FrontSide as ae,InterleavedBufferAttribute as se,VectorKeyframeTrack as ne,QuaternionKeyframeTrack as ie,NumberKeyframeTrack as oe,Vector3 as le,Box3 as pe,Sphere as ue}from"../../../../three.js";var ce=function(){function ce(e){t.call(this,e),this.dracoLoader=null,this.ddsLoader=null}function de(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}ce.prototype=Object.assign(Object.create(t.prototype),{constructor:ce,load:function(e,t,s,n){var i,o=this;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:r.extractUrlBase(e),o.manager.itemStart(e);var l=function(t){n?n(t):console.error(t),o.manager.itemError(e),o.manager.itemEnd(e)},p=new a(o.manager);p.setPath(this.path),p.setResponseType("arraybuffer"),"use-credentials"===o.crossOrigin&&p.setWithCredentials(!0),p.load(e,(function(r){try{o.parse(r,i,(function(r){t(r),o.manager.itemEnd(e)}),l)}catch(e){l(e)}}),s,l)},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(e){return this.ddsLoader=e,this},parse:function(e,t,a,s){var n,i={};if("string"==typeof e)n=e;else if(r.decodeText(new Uint8Array(e,0,4))===ge){try{i[he.KHR_BINARY_GLTF]=new Se(e)}catch(e){return void(s&&s(e))}n=i[he.KHR_BINARY_GLTF].content}else n=r.decodeText(new Uint8Array(e));var o=JSON.parse(n);if(void 0===o.asset||o.asset.version[0]<2)s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{if(o.extensionsUsed)for(var l=0;l<o.extensionsUsed.length;++l){var p=o.extensionsUsed[l],u=o.extensionsRequired||[];switch(p){case he.KHR_LIGHTS_PUNCTUAL:i[p]=new fe(o);break;case he.KHR_MATERIALS_UNLIT:i[p]=new ve;break;case he.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:i[p]=new _e;break;case he.KHR_DRACO_MESH_COMPRESSION:i[p]=new ye(o,this.dracoLoader);break;case he.MSFT_TEXTURE_DDS:i[p]=new me(this.ddsLoader);break;case he.KHR_TEXTURE_TRANSFORM:i[p]=new Re;break;case he.KHR_MESH_QUANTIZATION:i[p]=new Ee;break;default:u.indexOf(p)>=0&&console.warn('THREE.GLTFLoader: Unknown extension "'+p+'".')}}new Ze(o,i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager}).parse(a,s)}}});var he={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function me(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=he.MSFT_TEXTURE_DDS,this.ddsLoader=e}function fe(e){this.name=he.KHR_LIGHTS_PUNCTUAL;var t=e.extensions&&e.extensions[he.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function ve(){this.name=he.KHR_MATERIALS_UNLIT}fe.prototype.loadLight=function(e){var t,r=this.lightDefs[e],a=new s(16777215);void 0!==r.color&&a.fromArray(r.color);var l=void 0!==r.range?r.range:0;switch(r.type){case"directional":(t=new o(a)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new i(a)).distance=l;break;case"spot":(t=new n(a)).distance=l,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,t.angle=r.spot.outerConeAngle,t.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+r.type+'".')}return t.position.set(0,0,0),t.decay=2,void 0!==r.intensity&&(t.intensity=r.intensity),t.name=r.name||"light_"+e,Promise.resolve(t)},ve.prototype.getMaterialType=function(){return l},ve.prototype.extendParams=function(e,t,r){var a=[];e.color=new s(1,1,1),e.opacity=1;var n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){var i=n.baseColorFactor;e.color.fromArray(i),e.opacity=i[3]}void 0!==n.baseColorTexture&&a.push(r.assignTexture(e,"map",n.baseColorTexture))}return Promise.all(a)};var ge="glTF",Me=12,Te={JSON:1313821514,BIN:5130562};function Se(e){this.name=he.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,Me);if(this.header={magic:r.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ge)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var a=new DataView(e,Me),s=0;s<a.byteLength;){var n=a.getUint32(s,!0);s+=4;var i=a.getUint32(s,!0);if(s+=4,i===Te.JSON){var o=new Uint8Array(e,Me+s,n);this.content=r.decodeText(o)}else if(i===Te.BIN){var l=Me+s;this.body=e.slice(l,l+n)}s+=n}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function ye(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=he.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t}function Re(){this.name=he.KHR_TEXTURE_TRANSFORM}function _e(){return{name:he.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return p},extendParams:function(e,t,r){var a=t.extensions[this.name],n=W.standard,i=u.clone(n.uniforms),o=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),l=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),p=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),c=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),d=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),h=n.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",o).replace("#include <metalnessmap_pars_fragment>",l).replace("#include <roughnessmap_fragment>",p).replace("#include <metalnessmap_fragment>",c).replace("#include <lights_physical_fragment>",d);delete i.roughness,delete i.metalness,delete i.roughnessMap,delete i.metalnessMap,i.specular={value:(new s).setHex(1118481)},i.glossiness={value:.5},i.specularMap={value:null},i.glossinessMap={value:null},e.vertexShader=n.vertexShader,e.fragmentShader=h,e.uniforms=i,e.defines={STANDARD:""},e.color=new s(1,1,1),e.opacity=1;var m=[];if(Array.isArray(a.diffuseFactor)){var f=a.diffuseFactor;e.color.fromArray(f),e.opacity=f[3]}if(void 0!==a.diffuseTexture&&m.push(r.assignTexture(e,"map",a.diffuseTexture)),e.emissive=new s(0,0,0),e.glossiness=void 0!==a.glossinessFactor?a.glossinessFactor:1,e.specular=new s(1,1,1),Array.isArray(a.specularFactor)&&e.specular.fromArray(a.specularFactor),void 0!==a.specularGlossinessTexture){var v=a.specularGlossinessTexture;m.push(r.assignTexture(e,"glossinessMap",v)),m.push(r.assignTexture(e,"specularMap",v))}return Promise.all(m)},createMaterial:function(e){var t=new p({defines:e.defines,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,fog:!0,lights:!0,opacity:e.opacity,transparent:e.transparent});return t.isGLTFSpecularGlossinessMaterial=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t.extensions.derivatives=!0,t},cloneMaterial:function(e){var t=e.clone();t.isGLTFSpecularGlossinessMaterial=!0;for(var r=this.specularGlossinessParams,a=0,s=r.length;a<s;a++){var n=e[r[a]];t[r[a]]=n&&n.isColor?n.clone():n}return t},refreshUniforms:function(e,t,r,a,s){if(!0===s.isGLTFSpecularGlossinessMaterial){var n,i=s.uniforms,o=s.defines;i.opacity.value=s.opacity,i.diffuse.value.copy(s.color),i.emissive.value.copy(s.emissive).multiplyScalar(s.emissiveIntensity),i.map.value=s.map,i.specularMap.value=s.specularMap,i.alphaMap.value=s.alphaMap,i.lightMap.value=s.lightMap,i.lightMapIntensity.value=s.lightMapIntensity,i.aoMap.value=s.aoMap,i.aoMapIntensity.value=s.aoMapIntensity,s.map?n=s.map:s.specularMap?n=s.specularMap:s.displacementMap?n=s.displacementMap:s.normalMap?n=s.normalMap:s.bumpMap?n=s.bumpMap:s.glossinessMap?n=s.glossinessMap:s.alphaMap?n=s.alphaMap:s.emissiveMap&&(n=s.emissiveMap),void 0!==n&&(n.isWebGLRenderTarget&&(n=n.texture),!0===n.matrixAutoUpdate&&n.updateMatrix(),i.uvTransform.value.copy(n.matrix)),s.envMap&&(i.envMap.value=s.envMap,i.envMapIntensity.value=s.envMapIntensity,i.flipEnvMap.value=s.envMap.isCubeTexture?-1:1,i.reflectivity.value=s.reflectivity,i.refractionRatio.value=s.refractionRatio,i.maxMipLevel.value=e.properties.get(s.envMap).__maxMipLevel),i.specular.value.copy(s.specular),i.glossiness.value=s.glossiness,i.glossinessMap.value=s.glossinessMap,i.emissiveMap.value=s.emissiveMap,i.bumpMap.value=s.bumpMap,i.normalMap.value=s.normalMap,i.displacementMap.value=s.displacementMap,i.displacementScale.value=s.displacementScale,i.displacementBias.value=s.displacementBias,null!==i.glossinessMap.value&&void 0===o.USE_GLOSSINESSMAP&&(o.USE_GLOSSINESSMAP="",o.USE_ROUGHNESSMAP=""),null===i.glossinessMap.value&&void 0!==o.USE_GLOSSINESSMAP&&(delete o.USE_GLOSSINESSMAP,delete o.USE_ROUGHNESSMAP)}}}}function Ee(){this.name=he.KHR_MESH_QUANTIZATION}function Ae(e,t,r,a){Y.call(this,e,t,r,a)}ye.prototype.decodePrimitive=function(e,t){var r=this.json,a=this.dracoLoader,s=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,i={},o={},l={};for(var p in n){var u=De[p]||p.toLowerCase();i[u]=n[p]}for(p in e.attributes){u=De[p]||p.toLowerCase();if(void 0!==n[p]){var c=r.accessors[e.attributes[p]],d=He[c.componentType];l[u]=d,o[u]=!0===c.normalized}}return t.getDependency("bufferView",s).then((function(e){return new Promise((function(t){a.decodeDracoFile(e,(function(e){for(var r in e.attributes){var a=e.attributes[r],s=o[r];void 0!==s&&(a.normalized=s)}t(e)}),i,l)}))}))},Re.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},Ae.prototype=Object.create(Y.prototype),Ae.prototype.constructor=Ae,Ae.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,a=this.valueSize,s=e*a*3+a,n=0;n!==a;n++)t[n]=r[s+n];return t},Ae.prototype.beforeStart_=Ae.prototype.copySampleValue_,Ae.prototype.afterEnd_=Ae.prototype.copySampleValue_,Ae.prototype.interpolate_=function(e,t,r,a){for(var s=this.resultBuffer,n=this.sampleValues,i=this.valueSize,o=2*i,l=3*i,p=a-t,u=(r-t)/p,c=u*u,d=c*u,h=e*l,m=h-l,f=-2*d+3*c,v=d-c,g=1-f,M=v-c+u,T=0;T!==i;T++){var S=n[m+T+i],y=n[m+T+o]*p,R=n[h+T+i],_=n[h+T]*p;s[T]=g*S+M*y+f*R+v*_}return s};var we,xe=0,Le=1,be=2,Ie=3,Pe=4,Ue=5,Oe=6,He={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ne={9728:J,9729:m,9984:Z,9985:q,9986:Q,9987:f},Ce={33071:$,33648:ee,10497:v},Fe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},De={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Ge={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Be={CUBICSPLINE:void 0,LINEAR:G,STEP:te},ke="OPAQUE",je="MASK",Ke="BLEND",Ve={"image/png":re,"image/jpeg":g};function ze(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:t+e)}function Xe(e,t,r){for(var a in r.extensions)void 0===e[a]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[a]=r.extensions[a])}function We(t,r){void 0!==r.extras&&("object"===e(r.extras)?Object.assign(t.userData,r.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+r.extras))}function Ye(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,a=t.weights.length;r<a;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(r=0,a=s.length;r<a;r++)e.morphTargetDictionary[s[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Je(e){for(var t="",r=Object.keys(e).sort(),a=0,s=r.length;a<s;a++)t+=r[a]+":"+e[r[a]]+";";return t}function Ze(e,t,r){this.json=e||{},this.extensions=t||{},this.options=r||{},this.cache=new de,this.primitiveCache={},this.textureLoader=new c(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new a(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function qe(e,t,r){var a=t.attributes,s=[];function n(t,a){return r.getDependency("accessor",t).then((function(t){e.setAttribute(a,t)}))}for(var i in a){var o=De[i]||i.toLowerCase();o in e.attributes||s.push(n(a[i],o))}if(void 0!==t.indices&&!e.index){var l=r.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));s.push(l)}return We(e,t),function(e,t,r){var a=t.attributes,s=new pe;if(void 0!==a.POSITION){var n=(d=r.json.accessors[a.POSITION]).min,i=d.max;s.set(new le(n[0],n[1],n[2]),new le(i[0],i[1],i[2]));var o=t.targets;if(void 0!==o)for(var l=new le,p=0,u=o.length;p<u;p++){var c=o[p];if(void 0!==c.POSITION){var d;n=(d=r.json.accessors[c.POSITION]).min,i=d.max;l.setX(Math.max(Math.abs(n[0]),Math.abs(i[0]))),l.setY(Math.max(Math.abs(n[1]),Math.abs(i[1]))),l.setZ(Math.max(Math.abs(n[2]),Math.abs(i[2]))),s.expandByVector(l)}}e.boundingBox=s;var h=new ue;s.getCenter(h.center),h.radius=s.min.distanceTo(s.max)/2,e.boundingSphere=h}}(e,t,r),Promise.all(s).then((function(){return void 0!==t.targets?function(e,t,r){for(var a=!1,s=!1,n=0,i=t.length;n<i;n++){if(void 0!==(p=t[n]).POSITION&&(a=!0),void 0!==p.NORMAL&&(s=!0),a&&s)break}if(!a&&!s)return Promise.resolve(e);var o=[],l=[];for(n=0,i=t.length;n<i;n++){var p=t[n];if(a){var u=void 0!==p.POSITION?r.getDependency("accessor",p.POSITION):e.attributes.position;o.push(u)}if(s){u=void 0!==p.NORMAL?r.getDependency("accessor",p.NORMAL):e.attributes.normal;l.push(u)}}return Promise.all([Promise.all(o),Promise.all(l)]).then((function(t){var r=t[0],n=t[1];return a&&(e.morphAttributes.position=r),s&&(e.morphAttributes.normal=n),e.morphTargetsRelative=!0,e}))}(e,t.targets,r):e}))}return Ze.prototype.parse=function(e,t){var r=this,a=this.json,s=this.extensions;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then((function(t){var n={scene:t[0][a.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:a.asset,parser:r,userData:{}};Xe(s,n,a),We(n,a),e(n)})).catch(t)},Ze.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],a={},s={},n=0,i=t.length;n<i;n++)for(var o=t[n].joints,l=0,p=o.length;l<p;l++)e[o[l]].isBone=!0;for(var u=0,c=e.length;u<c;u++){var d=e[u];void 0!==d.mesh&&(void 0===a[d.mesh]&&(a[d.mesh]=s[d.mesh]=0),a[d.mesh]++,void 0!==d.skin&&(r[d.mesh].isSkinnedMesh=!0))}this.json.meshReferences=a,this.json.meshUses=s},Ze.prototype.getDependency=function(e,t){var r=e+":"+t,a=this.cache.get(r);if(!a){switch(e){case"scene":a=this.loadScene(t);break;case"node":a=this.loadNode(t);break;case"mesh":a=this.loadMesh(t);break;case"accessor":a=this.loadAccessor(t);break;case"bufferView":a=this.loadBufferView(t);break;case"buffer":a=this.loadBuffer(t);break;case"material":a=this.loadMaterial(t);break;case"texture":a=this.loadTexture(t);break;case"skin":a=this.loadSkin(t);break;case"animation":a=this.loadAnimation(t);break;case"camera":a=this.loadCamera(t);break;case"light":a=this.extensions[he.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(r,a)}return a},Ze.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,a=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(a.map((function(t,a){return r.getDependency(e,a)}))),this.cache.add(e,t)}return t},Ze.prototype.loadBuffer=function(e){var t=this.json.buffers[e],r=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[he.KHR_BINARY_GLTF].body);var a=this.options;return new Promise((function(e,s){r.load(ze(t.uri,a.path),e,void 0,(function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},Ze.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var r=t.byteLength||0,a=t.byteOffset||0;return e.slice(a,a+r)}))},Ze.prototype.loadAccessor=function(e){var t=this,r=this.json,a=this.json.accessors[e];if(void 0===a.bufferView&&void 0===a.sparse)return Promise.resolve(null);var s=[];return void 0!==a.bufferView?s.push(this.getDependency("bufferView",a.bufferView)):s.push(null),void 0!==a.sparse&&(s.push(this.getDependency("bufferView",a.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",a.sparse.values.bufferView))),Promise.all(s).then((function(e){var s,n,i=e[0],o=Fe[a.type],l=He[a.componentType],p=l.BYTES_PER_ELEMENT,u=p*o,c=a.byteOffset||0,m=void 0!==a.bufferView?r.bufferViews[a.bufferView].byteStride:void 0,f=!0===a.normalized;if(m&&m!==u){var v=Math.floor(c/m),g="InterleavedBuffer:"+a.bufferView+":"+a.componentType+":"+v+":"+a.count,M=t.cache.get(g);M||(s=new l(i,v*m,a.count*m/p),M=new d(s,m/p),t.cache.add(g,M)),n=new se(M,o,c%m/p,f)}else s=null===i?new l(a.count*o):new l(i,c,a.count*o),n=new h(s,o,f);if(void 0!==a.sparse){var T=Fe.SCALAR,S=He[a.sparse.indices.componentType],y=a.sparse.indices.byteOffset||0,R=a.sparse.values.byteOffset||0,_=new S(e[1],y,a.sparse.count*T),E=new l(e[2],R,a.sparse.count*o);null!==i&&(n=new h(n.array.slice(),n.itemSize,n.normalized));for(var A=0,w=_.length;A<w;A++){var x=_[A];if(n.setX(x,E[A*o]),o>=2&&n.setY(x,E[A*o+1]),o>=3&&n.setZ(x,E[A*o+2]),o>=4&&n.setW(x,E[A*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return n}))},Ze.prototype.loadTexture=function(e){var t,r=this,a=this.json,s=this.options,n=this.textureLoader,i=window.URL||window.webkitURL,o=a.textures[e],l=o.extensions||{},p=(t=l[he.MSFT_TEXTURE_DDS]?a.images[l[he.MSFT_TEXTURE_DDS].source]:a.images[o.source]).uri,u=!1;return void 0!==t.bufferView&&(p=r.getDependency("bufferView",t.bufferView).then((function(e){u=!0;var r=new Blob([e],{type:t.mimeType});return p=i.createObjectURL(r)}))),Promise.resolve(p).then((function(e){var t=s.manager.getHandler(e);return t||(t=l[he.MSFT_TEXTURE_DDS]?r.extensions[he.MSFT_TEXTURE_DDS].ddsLoader:n),new Promise((function(r,a){t.load(ze(e,s.path),r,void 0,a)}))})).then((function(e){!0===u&&i.revokeObjectURL(p),e.flipY=!1,void 0!==o.name&&(e.name=o.name),t.mimeType in Ve&&(e.format=Ve[t.mimeType]);var r=(a.samplers||{})[o.sampler]||{};return e.magFilter=Ne[r.magFilter]||m,e.minFilter=Ne[r.minFilter]||f,e.wrapS=Ce[r.wrapS]||v,e.wrapT=Ce[r.wrapT]||v,e}))},Ze.prototype.assignTexture=function(e,t,r){var a=this;return this.getDependency("texture",r.index).then((function(s){if(!s.isCompressedTexture)switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":s.format=g}if(a.extensions[he.KHR_TEXTURE_TRANSFORM]){var n=void 0!==r.extensions?r.extensions[he.KHR_TEXTURE_TRANSFORM]:void 0;n&&(s=a.extensions[he.KHR_TEXTURE_TRANSFORM].extendTexture(s,n))}e[t]=s}))},Ze.prototype.assignFinalMaterial=function(e){var t=e.geometry,r=e.material,a=this.extensions,s=void 0!==t.attributes.tangent,n=void 0!==t.attributes.color,i=void 0===t.attributes.normal,o=!0===e.isSkinnedMesh,l=Object.keys(t.morphAttributes).length>0,p=l&&void 0!==t.morphAttributes.normal;if(e.isPoints){var u="PointsMaterial:"+r.uuid,c=this.cache.get(u);c||(c=new M,T.prototype.copy.call(c,r),c.color.copy(r.color),c.map=r.map,c.sizeAttenuation=!1,this.cache.add(u,c)),r=c}else if(e.isLine){u="LineBasicMaterial:"+r.uuid;var d=this.cache.get(u);d||(d=new S,T.prototype.copy.call(d,r),d.color.copy(r.color),this.cache.add(u,d)),r=d}if(s||n||i||o||l){u="ClonedMaterial:"+r.uuid+":";r.isGLTFSpecularGlossinessMaterial&&(u+="specular-glossiness:"),o&&(u+="skinning:"),s&&(u+="vertex-tangents:"),n&&(u+="vertex-colors:"),i&&(u+="flat-shading:"),l&&(u+="morph-targets:"),p&&(u+="morph-normals:");var m=this.cache.get(u);m||(m=r.isGLTFSpecularGlossinessMaterial?a[he.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(r):r.clone(),o&&(m.skinning=!0),s&&(m.vertexTangents=!0),n&&(m.vertexColors=y),i&&(m.flatShading=!0),l&&(m.morphTargets=!0),p&&(m.morphNormals=!0),this.cache.add(u,m)),r=m}r.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&(console.log("THREE.GLTFLoader: Duplicating UVs to support aoMap."),t.setAttribute("uv2",new h(t.attributes.uv.array,2))),r.isGLTFSpecularGlossinessMaterial&&(e.onBeforeRender=a[he.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms),e.material=r},Ze.prototype.loadMaterial=function(e){var t,r=this.json,a=this.extensions,n=r.materials[e],i={},o=n.extensions||{},u=[];if(o[he.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var c=a[he.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=c.getMaterialType(),u.push(c.extendParams(i,n,this))}else if(o[he.KHR_MATERIALS_UNLIT]){var d=a[he.KHR_MATERIALS_UNLIT];t=d.getMaterialType(),u.push(d.extendParams(i,n,this))}else{t=R;var h=n.pbrMetallicRoughness||{};if(i.color=new s(1,1,1),i.opacity=1,Array.isArray(h.baseColorFactor)){var m=h.baseColorFactor;i.color.fromArray(m),i.opacity=m[3]}void 0!==h.baseColorTexture&&u.push(this.assignTexture(i,"map",h.baseColorTexture)),i.metalness=void 0!==h.metallicFactor?h.metallicFactor:1,i.roughness=void 0!==h.roughnessFactor?h.roughnessFactor:1,void 0!==h.metallicRoughnessTexture&&(u.push(this.assignTexture(i,"metalnessMap",h.metallicRoughnessTexture)),u.push(this.assignTexture(i,"roughnessMap",h.metallicRoughnessTexture)))}!0===n.doubleSided&&(i.side=_);var f=n.alphaMode||ke;return f===Ke?i.transparent=!0:(i.transparent=!1,f===je&&(i.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&t!==l&&(u.push(this.assignTexture(i,"normalMap",n.normalTexture)),i.normalScale=new E(1,1),void 0!==n.normalTexture.scale&&i.normalScale.set(n.normalTexture.scale,n.normalTexture.scale)),void 0!==n.occlusionTexture&&t!==l&&(u.push(this.assignTexture(i,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(i.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&t!==l&&(i.emissive=(new s).fromArray(n.emissiveFactor)),void 0!==n.emissiveTexture&&t!==l&&u.push(this.assignTexture(i,"emissiveMap",n.emissiveTexture)),Promise.all(u).then((function(){var e;return e=t===p?a[he.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(i):new t(i),void 0!==n.name&&(e.name=n.name),e.map&&(e.map.encoding=A),e.emissiveMap&&(e.emissiveMap.encoding=A),e.specularMap&&(e.specularMap.encoding=A),We(e,n),n.extensions&&Xe(a,e,n),e}))},Ze.prototype.loadGeometries=function(e){var t=this,r=this.extensions,a=this.primitiveCache;function s(e){return r[he.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(r){return qe(r,e,t)}))}for(var n,i,o=[],l=0,p=e.length;l<p;l++){var u,c=e[l],d=(i=void 0,(i=(n=c).extensions&&n.extensions[he.KHR_DRACO_MESH_COMPRESSION])?"draco:"+i.bufferView+":"+i.indices+":"+Je(i.attributes):n.indices+":"+Je(n.attributes)+":"+n.mode),h=a[d];if(h)o.push(h.promise);else u=c.extensions&&c.extensions[he.KHR_DRACO_MESH_COMPRESSION]?s(c):qe(new w,c,t),a[d]={primitive:c,promise:u},o.push(u)}return Promise.all(o)},Ze.prototype.loadMesh=function(e){for(var t=this,r=this.json.meshes[e],a=r.primitives,s=[],n=0,i=a.length;n<i;n++){var o=void 0===a[n].material?we=we||new R({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ae}):this.getDependency("material",a[n].material);s.push(o)}return Promise.all(s).then((function(s){return t.loadGeometries(a).then((function(n){for(var i=[],o=0,l=n.length;o<l;o++){var p,u=n[o],c=a[o],d=s[o];if(c.mode===Pe||c.mode===Ue||c.mode===Oe||void 0===c.mode)!0!==(p=!0===r.isSkinnedMesh?new x(u,d):new L(u,d)).isSkinnedMesh||p.geometry.attributes.skinWeight.normalized||p.normalizeSkinWeights(),c.mode===Ue?p.drawMode=b:c.mode===Oe&&(p.drawMode=I);else if(c.mode===Le)p=new P(u,d);else if(c.mode===Ie)p=new U(u,d);else if(c.mode===be)p=new O(u,d);else{if(c.mode!==xe)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);p=new H(u,d)}Object.keys(p.geometry.morphAttributes).length>0&&Ye(p,r),p.name=r.name||"mesh_"+e,n.length>1&&(p.name+="_"+o),We(p,r),t.assignFinalMaterial(p),i.push(p)}if(1===i.length)return i[0];var h=new N;for(o=0,l=i.length;o<l;o++)h.add(i[o]);return h}))}))},Ze.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],a=r[r.type];if(a)return"perspective"===r.type?t=new C(F.radToDeg(a.yfov),a.aspectRatio||1,a.znear||1,a.zfar||2e6):"orthographic"===r.type&&(t=new D(a.xmag/-2,a.xmag/2,a.ymag/2,a.ymag/-2,a.znear,a.zfar)),void 0!==r.name&&(t.name=r.name),We(t,r),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},Ze.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return r.inverseBindMatrices=e,r}))},Ze.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],r=[],a=[],s=[],n=[],i=[],o=0,l=t.channels.length;o<l;o++){var p=t.channels[o],u=t.samplers[p.sampler],c=p.target,d=void 0!==c.node?c.node:c.id,h=void 0!==t.parameters?t.parameters[u.input]:u.input,m=void 0!==t.parameters?t.parameters[u.output]:u.output;r.push(this.getDependency("node",d)),a.push(this.getDependency("accessor",h)),s.push(this.getDependency("accessor",m)),n.push(u),i.push(c)}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(s),Promise.all(n),Promise.all(i)]).then((function(r){for(var a=r[0],s=r[1],n=r[2],i=r[3],o=r[4],l=[],p=0,u=a.length;p<u;p++){var c=a[p],d=s[p],h=n[p],m=i[p],f=o[p];if(void 0!==c){var v;switch(c.updateMatrix(),c.matrixAutoUpdate=!0,Ge[f.path]){case Ge.weights:v=oe;break;case Ge.rotation:v=ie;break;case Ge.position:case Ge.scale:default:v=ne}var g=c.name?c.name:c.uuid,M=void 0!==m.interpolation?Be[m.interpolation]:G,T=[];Ge[f.path]===Ge.weights?c.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&T.push(e.name?e.name:e.uuid)})):T.push(g);var S=h.array;if(h.normalized){var y;if(S.constructor===Int8Array)y=1/127;else if(S.constructor===Uint8Array)y=1/255;else if(S.constructor==Int16Array)y=1/32767;else{if(S.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");y=1/65535}for(var R=new Float32Array(S.length),_=0,E=S.length;_<E;_++)R[_]=S[_]*y;S=R}for(_=0,E=T.length;_<E;_++){var A=new v(T[_]+"."+Ge[f.path],d.array,S,M);"CUBICSPLINE"===m.interpolation&&(A.createInterpolant=function(e){return new Ae(this.times,this.values,this.getValueSize()/3,e)},A.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(A)}}}var w=void 0!==t.name?t.name:"animation_"+e;return new B(w,void 0,l)}))},Ze.prototype.loadNode=function(e){var t,r=this.json,a=this.extensions,s=this,n=r.meshReferences,i=r.meshUses,o=r.nodes[e];return(t=[],void 0!==o.mesh&&t.push(s.getDependency("mesh",o.mesh).then((function(e){var t;if(n[o.mesh]>1){var r=i[o.mesh]++;(t=e.clone()).name+="_instance_"+r,t.onBeforeRender=e.onBeforeRender;for(var a=0,s=t.children.length;a<s;a++)t.children[a].name+="_instance_"+r,t.children[a].onBeforeRender=e.children[a].onBeforeRender}else t=e;return void 0!==o.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,r=o.weights.length;t<r;t++)e.morphTargetInfluences[t]=o.weights[t]})),t}))),void 0!==o.camera&&t.push(s.getDependency("camera",o.camera)),o.extensions&&o.extensions[he.KHR_LIGHTS_PUNCTUAL]&&void 0!==o.extensions[he.KHR_LIGHTS_PUNCTUAL].light&&t.push(s.getDependency("light",o.extensions[he.KHR_LIGHTS_PUNCTUAL].light)),Promise.all(t)).then((function(e){var t;if((t=!0===o.isBone?new k:e.length>1?new N:1===e.length?e[0]:new j)!==e[0])for(var r=0,s=e.length;r<s;r++)t.add(e[r]);if(void 0!==o.name&&(t.userData.name=o.name,t.name=K.sanitizeNodeName(o.name)),We(t,o),o.extensions&&Xe(a,t,o),void 0!==o.matrix){var n=new V;n.fromArray(o.matrix),t.applyMatrix(n)}else void 0!==o.translation&&t.position.fromArray(o.translation),void 0!==o.rotation&&t.quaternion.fromArray(o.rotation),void 0!==o.scale&&t.scale.fromArray(o.scale);return t}))},Ze.prototype.loadScene=function(){function e(t,r,a,s){var n=a.nodes[t];return s.getDependency("node",t).then((function(e){return void 0===n.skin?e:s.getDependency("skin",n.skin).then((function(e){for(var r=[],a=0,n=(t=e).joints.length;a<n;a++)r.push(s.getDependency("node",t.joints[a]));return Promise.all(r)})).then((function(r){return e.traverse((function(e){if(e.isMesh){for(var a=[],s=[],n=0,i=r.length;n<i;n++){var o=r[n];if(o){a.push(o);var l=new V;void 0!==t.inverseBindMatrices&&l.fromArray(t.inverseBindMatrices.array,16*n),s.push(l)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[n])}e.bind(new X(a,s),e.matrixWorld)}})),e}));var t})).then((function(t){r.add(t);var i=[];if(n.children)for(var o=n.children,l=0,p=o.length;l<p;l++){var u=o[l];i.push(e(u,t,a,s))}return Promise.all(i)}))}return function(t){var r=this.json,a=this.extensions,s=this.json.scenes[t],n=new z;void 0!==s.name&&(n.name=s.name),We(n,s),s.extensions&&Xe(a,n,s);for(var i=s.nodes||[],o=[],l=0,p=i.length;l<p;l++)o.push(e(i[l],n,r,this));return Promise.all(o).then((function(){return n}))}}(),ce}();export{ce as GLTFLoader};
//# sourceMappingURL=GLTFLoader.js.map
